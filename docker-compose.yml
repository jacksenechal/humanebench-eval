services:
  chat:
    build: ./chat
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_CHAT_MODEL=${GEMINI_CHAT_MODEL:-gemini-3-flash-preview}
      - GEMINI_EVAL_MODEL=${GEMINI_EVAL_MODEL:-gemini-3-pro-preview}
      - HUMANEBENCH_URL=http://dashboard:8000
    depends_on:
      - dashboard
    restart: unless-stopped

  dashboard:
    build: ./dashboard
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - HUMANEBENCH_CORS_ORIGINS=*
      - HUMANEBENCH_DB_PATH=/data/humanebench.db
    volumes:
      - dashboard-data:/data
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "8080:8080"
      - "8081:8081"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - chat
      - dashboard
    restart: unless-stopped

  tunnel-chat:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate --url http://nginx:8080
    depends_on:
      - nginx
    restart: unless-stopped

  tunnel-dashboard:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate --url http://nginx:8081
    depends_on:
      - nginx
    restart: unless-stopped

volumes:
  dashboard-data:
