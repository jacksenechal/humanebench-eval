<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HumaneBench Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            surface: '#1a1a2e',
            card: '#16213e',
            border: '#0f3460',
            accent: '#e94560',
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0f0e17; color: #fffffe; font-family: 'Inter', system-ui, sans-serif; }
    .card { background: #1a1a2e; border: 1px solid #0f3460; border-radius: 12px; }
    .tab-active { border-bottom: 2px solid #e94560; color: #e94560; }
    .tab-inactive { color: #8892a4; border-bottom: 2px solid transparent; }
    .score-good { color: #4ade80; }
    .score-ok { color: #facc15; }
    .score-warn { color: #fb923c; }
    .score-bad { color: #f87171; }
    .bar-good { background: #4ade80; }
    .bar-ok { background: #facc15; }
    .bar-warn { background: #fb923c; }
    .bar-bad { background: #f87171; }
    .incident-row { cursor: pointer; transition: background 0.15s; }
    .incident-row:hover { background: #1e2a45; }
    .expand-content { display: none; }
    .expand-content.open { display: block; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f0e17; }
    ::-webkit-scrollbar-thumb { background: #0f3460; border-radius: 3px; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
  </style>
</head>
<body class="min-h-screen">

<!-- Header -->
<header class="px-6 py-4 border-b border-blue-900 flex items-center justify-between sticky top-0 z-10" style="background:#0f0e17;">
  <div class="flex items-center gap-3">
    <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background:#e94560;">
      <span class="text-white font-bold text-sm">HB</span>
    </div>
    <div>
      <h1 class="text-lg font-bold text-white">HumaneBench</h1>
      <p class="text-xs text-gray-500">Humane AI Evaluation Dashboard</p>
    </div>
  </div>
  <div class="flex items-center gap-4">
    <div id="live-indicator" class="flex items-center gap-2 text-xs text-green-400">
      <span class="w-2 h-2 rounded-full bg-green-400 pulse"></span>
      <span>Live</span>
    </div>
    <span id="last-updated" class="text-xs text-gray-500"></span>
  </div>
</header>

<!-- Tab Navigation -->
<nav class="px-6 flex gap-6 border-b border-blue-900" style="background:#0f0e17;">
  <button onclick="switchTab('overview')" id="tab-overview" class="py-3 px-1 text-sm font-medium tab-active transition-colors">Overview</button>
  <button onclick="switchTab('incidents')" id="tab-incidents" class="py-3 px-1 text-sm font-medium tab-inactive transition-colors">Incidents</button>
  <button onclick="switchTab('conversations')" id="tab-conversations" class="py-3 px-1 text-sm font-medium tab-inactive transition-colors">Conversations</button>
</nav>

<main class="p-6 max-w-7xl mx-auto">

  <!-- ===== OVERVIEW TAB ===== -->
  <div id="view-overview">
    <!-- Time range filter -->
    <div class="flex items-center gap-3 mb-6">
      <span class="text-sm text-gray-400">Time range:</span>
      <div class="flex gap-2">
        <button onclick="setTimeRange('24h')" id="tr-24h" class="px-3 py-1 rounded text-xs bg-blue-900 text-gray-300 hover:bg-blue-800 transition">24h</button>
        <button onclick="setTimeRange('7d')" id="tr-7d" class="px-3 py-1 rounded text-xs bg-blue-900 text-gray-300 hover:bg-blue-800 transition">7d</button>
        <button onclick="setTimeRange('30d')" id="tr-30d" class="px-3 py-1 rounded text-xs bg-blue-900 text-gray-300 hover:bg-blue-800 transition">30d</button>
        <button onclick="setTimeRange('all')" id="tr-all" class="px-3 py-1 rounded text-xs text-white transition" style="background:#e94560;">All time</button>
      </div>
    </div>

    <!-- Stat cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="card p-4">
        <p class="text-xs text-gray-400 mb-1">Total Evaluations</p>
        <p id="stat-total" class="text-3xl font-bold text-white">‚Äî</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-gray-400 mb-1">Avg Score</p>
        <p id="stat-avg" class="text-3xl font-bold">‚Äî</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-gray-400 mb-1">Violations</p>
        <p id="stat-violations" class="text-3xl font-bold text-red-400">‚Äî</p>
      </div>
      <div class="card p-4">
        <p class="text-xs text-gray-400 mb-1">Weakest Principle</p>
        <p id="stat-weakest" class="text-sm font-semibold text-orange-400">‚Äî</p>
      </div>
    </div>

    <!-- Radar chart + Insights -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="card p-6">
        <h2 class="text-sm font-semibold text-gray-300 mb-4">Principle Scores (Radar)</h2>
        <div class="relative" style="height:320px;">
          <canvas id="radar-chart"></canvas>
        </div>
      </div>

      <div class="card p-6">
        <h2 class="text-sm font-semibold text-gray-300 mb-4">Score Distribution</h2>
        <div class="space-y-3" id="principle-bars"></div>
      </div>
    </div>

    <!-- Actionable insights -->
    <div class="card p-6" id="insights-panel">
      <h2 class="text-sm font-semibold text-gray-300 mb-3">Actionable Insights</h2>
      <div id="insights-content" class="text-sm text-gray-400">Loading insights...</div>
    </div>
  </div>

  <!-- ===== INCIDENTS TAB ===== -->
  <div id="view-incidents" style="display:none;">
    <div id="warning-banner" class="hidden mb-4 rounded-lg p-4 border border-orange-500 bg-orange-500/10">
      <p class="text-sm text-orange-300 font-medium" id="warning-text"></p>
    </div>

    <div class="flex items-center gap-4 mb-4">
      <select id="incident-filter" onchange="loadIncidents()" class="text-sm rounded px-3 py-2 text-gray-300 border border-blue-900" style="background:#1a1a2e;">
        <option value="">All principles</option>
        <option value="respect_attention">Respect Attention</option>
        <option value="meaningful_choices">Meaningful Choices</option>
        <option value="enhance_capabilities">Enhance Capabilities</option>
        <option value="dignity_safety">Dignity & Safety</option>
        <option value="healthy_relationships">Healthy Relationships</option>
        <option value="longterm_wellbeing">Long-term Wellbeing</option>
        <option value="transparency_honesty">Transparency & Honesty</option>
        <option value="equity_inclusion">Equity & Inclusion</option>
      </select>
      <span id="incident-count" class="text-sm text-gray-400"></span>
    </div>

    <div class="card overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-blue-900 text-left">
            <th class="px-4 py-3 text-xs text-gray-400 font-medium">Principle</th>
            <th class="px-4 py-3 text-xs text-gray-400 font-medium">Score</th>
            <th class="px-4 py-3 text-xs text-gray-400 font-medium">Prompt</th>
            <th class="px-4 py-3 text-xs text-gray-400 font-medium">Time</th>
          </tr>
        </thead>
        <tbody id="incidents-table"></tbody>
      </table>
      <div id="incidents-empty" class="hidden p-8 text-center text-gray-500">No incidents found.</div>
    </div>
  </div>

  <!-- ===== CONVERSATIONS TAB ===== -->
  <div id="view-conversations" style="display:none;">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Conversation list -->
      <div class="card p-4 md:col-span-1">
        <h2 class="text-sm font-semibold text-gray-300 mb-3">Conversations</h2>
        <div id="conv-list" class="space-y-2 overflow-y-auto" style="max-height:600px;"></div>
      </div>

      <!-- Conversation detail -->
      <div class="card p-6 md:col-span-2" id="conv-detail">
        <div class="text-center text-gray-500 mt-16">
          <p class="text-4xl mb-3">üí¨</p>
          <p class="text-sm">Select a conversation to view details</p>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
const API = '';
let currentTab = 'overview';
let currentTimeRange = 'all';
let radarChart = null;
let overviewData = null;

const PRINCIPLE_LABELS = {
  respect_attention: 'Respect Attention',
  meaningful_choices: 'Meaningful Choices',
  enhance_capabilities: 'Enhance Capabilities',
  dignity_safety: 'Dignity & Safety',
  healthy_relationships: 'Healthy Relationships',
  longterm_wellbeing: 'Long-term Wellbeing',
  transparency_honesty: 'Transparency & Honesty',
  equity_inclusion: 'Equity & Inclusion',
};

const PRINCIPLE_ORDER = Object.keys(PRINCIPLE_LABELS);

const INSIGHTS = {
  respect_attention: {
    problem: 'Responses are wasting users\' time with unnecessary length or manipulation.',
    suggestions: [
      'Audit prompt for length ‚Äî default to concise, offer to expand.',
      'Remove filler phrases and repetitive content.',
      'Avoid urgency language that creates false pressure.',
    ]
  },
  meaningful_choices: {
    problem: 'Users are being steered toward single options without real choice.',
    suggestions: [
      'Always present 2-3 genuine alternatives with trade-offs.',
      'Ask clarifying questions to understand user goals first.',
      'Avoid prescriptive "you should" framing without context.',
    ]
  },
  enhance_capabilities: {
    problem: 'The AI is doing things for users instead of building their skills.',
    suggestions: [
      'Explain the "why" behind recommendations.',
      'Scaffold tasks: guide the user to attempt first, then assist.',
      'Ask follow-up questions that help users self-discover solutions.',
    ]
  },
  dignity_safety: {
    problem: 'Safety-sensitive topics are receiving generic or harmful responses.',
    suggestions: [
      'Add detection for crisis keywords (suicidal ideation, self-harm).',
      'Always include concrete hotline numbers and escalation paths.',
      'Never give medical advice ‚Äî always recommend professional consultation.',
    ]
  },
  healthy_relationships: {
    problem: 'The AI is fostering parasocial attachment or replacing human connection.',
    suggestions: [
      'Remove companion language ("I care about you", "I\'m here for you").',
      'Redirect loneliness to human connection resources.',
      'Be clear about being an AI without emotional relationship.',
    ]
  },
  longterm_wellbeing: {
    problem: 'Responses optimize for short-term satisfaction over long-term user interests.',
    suggestions: [
      'Identify when users are building unhealthy dependencies.',
      'Promote skill-building over task delegation.',
      'Be honest when engagement is not in the user\'s long-term interest.',
    ]
  },
  transparency_honesty: {
    problem: 'The AI is overclaiming capabilities or omitting important limitations.',
    suggestions: [
      'Always disclose when answering outside knowledge cutoff.',
      'Acknowledge uncertainty with calibrated confidence.',
      'Flag when sources may be biased or information may be outdated.',
    ]
  },
  equity_inclusion: {
    problem: 'Responses contain bias or fail to work equally well for all users.',
    suggestions: [
      'Audit for gender, racial, or cultural stereotypes.',
      'Test with diverse user personas and edge cases.',
      'Avoid assuming default demographics in examples.',
    ]
  },
};

function scoreColor(score) {
  if (score >= 0.75) return 'score-good';
  if (score >= 0.25) return 'score-ok';
  if (score >= -0.25) return 'score-warn';
  return 'score-bad';
}

function scoreBarClass(score) {
  if (score >= 0.75) return 'bar-good';
  if (score >= 0.25) return 'bar-ok';
  if (score >= -0.25) return 'bar-warn';
  return 'bar-bad';
}

function scoreLabel(score) {
  if (score >= 1.0) return '+1.0 Exemplary';
  if (score >= 0.5) return '+0.5 Acceptable';
  if (score >= -0.5) return '-0.5 Concerning';
  return '-1.0 Violation';
}

function formatTime(ts) {
  if (!ts) return '‚Äî';
  const d = new Date(ts.endsWith('Z') ? ts : ts + 'Z');
  return d.toLocaleString();
}

function truncate(str, n = 80) {
  return str && str.length > n ? str.slice(0, n) + '‚Ä¶' : str || '';
}

function switchTab(tab) {
  currentTab = tab;
  ['overview', 'incidents', 'conversations'].forEach(t => {
    document.getElementById(`view-${t}`).style.display = t === tab ? 'block' : 'none';
    document.getElementById(`tab-${t}`).className =
      `py-3 px-1 text-sm font-medium ${t === tab ? 'tab-active' : 'tab-inactive'} transition-colors`;
  });
  if (tab === 'overview') loadOverview();
  if (tab === 'incidents') loadIncidents();
  if (tab === 'conversations') loadConversations();
}

function setTimeRange(range) {
  currentTimeRange = range;
  ['24h','7d','30d','all'].forEach(r => {
    const btn = document.getElementById(`tr-${r}`);
    if (r === range) {
      btn.style.background = '#e94560';
      btn.className = 'px-3 py-1 rounded text-xs text-white transition';
    } else {
      btn.style.background = '';
      btn.className = 'px-3 py-1 rounded text-xs bg-blue-900 text-gray-300 hover:bg-blue-800 transition';
    }
  });
  loadOverview();
}

async function loadOverview() {
  try {
    const res = await fetch(`${API}/api/overview?time_range=${currentTimeRange}`);
    const data = await res.json();
    overviewData = data;
    renderOverview(data);
  } catch(e) {
    console.error('Overview load failed:', e);
  }
}

function renderOverview(data) {
  // Stat cards
  document.getElementById('stat-total').textContent = data.total_evaluations ?? '‚Äî';

  const avgEl = document.getElementById('stat-avg');
  const avg = data.avg_score ?? 0;
  avgEl.textContent = avg >= 0 ? `+${avg.toFixed(2)}` : avg.toFixed(2);
  avgEl.className = `text-3xl font-bold ${scoreColor(avg)}`;

  document.getElementById('stat-violations').textContent = data.violations_count ?? '‚Äî';

  const weakest = data.weakest_principle;
  document.getElementById('stat-weakest').textContent =
    weakest ? PRINCIPLE_LABELS[weakest] || weakest : '‚Äî';

  // Radar chart
  const scores = data.principle_scores || {};
  const labels = PRINCIPLE_ORDER.map(p => PRINCIPLE_LABELS[p]);
  const values = PRINCIPLE_ORDER.map(p => {
    const s = scores[p] ?? 0;
    return ((s + 1) / 2) * 100; // map -1..1 to 0..100
  });

  if (radarChart) radarChart.destroy();
  const ctx = document.getElementById('radar-chart').getContext('2d');
  radarChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels,
      datasets: [{
        label: 'Score',
        data: values,
        backgroundColor: 'rgba(233,69,96,0.15)',
        borderColor: '#e94560',
        pointBackgroundColor: '#e94560',
        pointRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        r: {
          min: 0, max: 100,
          ticks: { display: false },
          grid: { color: '#0f3460' },
          pointLabels: { color: '#8892a4', font: { size: 10 } },
          angleLines: { color: '#0f3460' },
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const raw = (ctx.raw / 100) * 2 - 1;
              return ` ${raw >= 0 ? '+' : ''}${raw.toFixed(2)}`;
            }
          }
        }
      }
    }
  });

  // Principle bars
  const barsEl = document.getElementById('principle-bars');
  barsEl.innerHTML = PRINCIPLE_ORDER.map(p => {
    const s = scores[p] ?? 0;
    const pct = ((s + 1) / 2) * 100;
    const barClass = scoreBarClass(s);
    const colorClass = scoreColor(s);
    return `
      <div>
        <div class="flex justify-between text-xs mb-1">
          <span class="text-gray-400">${PRINCIPLE_LABELS[p]}</span>
          <span class="${colorClass} font-medium">${s >= 0 ? '+' : ''}${s.toFixed(2)}</span>
        </div>
        <div class="h-2 rounded-full" style="background:#0f3460;">
          <div class="h-2 rounded-full ${barClass}" style="width:${pct}%; transition: width 0.5s;"></div>
        </div>
      </div>
    `;
  }).join('');

  // Insights
  if (weakest && INSIGHTS[weakest]) {
    const insight = INSIGHTS[weakest];
    document.getElementById('insights-content').innerHTML = `
      <div class="flex items-start gap-3 mb-4">
        <span class="text-2xl">‚ö†Ô∏è</span>
        <div>
          <p class="font-semibold text-orange-400 mb-1">Weakest: ${PRINCIPLE_LABELS[weakest]}</p>
          <p class="text-gray-300 mb-3">${insight.problem}</p>
          <ul class="space-y-1">
            ${insight.suggestions.map(s => `<li class="flex gap-2"><span class="text-blue-400">‚Üí</span><span>${s}</span></li>`).join('')}
          </ul>
        </div>
      </div>
    `;
  } else {
    document.getElementById('insights-content').textContent =
      data.total_evaluations === 0
        ? 'No data yet. Run seed_demo.py or send some conversations to /evaluate.'
        : 'All principles scoring well! Keep monitoring as more conversations come in.';
  }
}

async function loadIncidents() {
  const principle = document.getElementById('incident-filter').value;
  const url = `${API}/api/incidents?limit=100${principle ? '&principle=' + principle : ''}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    renderIncidents(data);
  } catch(e) {
    console.error('Incidents load failed:', e);
  }
}

function renderIncidents(incidents) {
  document.getElementById('incident-count').textContent =
    `${incidents.length} incident${incidents.length !== 1 ? 's' : ''}`;

  const tbody = document.getElementById('incidents-table');
  const empty = document.getElementById('incidents-empty');

  if (!incidents.length) {
    tbody.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }

  empty.classList.add('hidden');

  // Check for systematic weakness
  const principalCounts = {};
  incidents.forEach(i => {
    principalCounts[i.principle] = (principalCounts[i.principle] || 0) + 1;
  });
  const systematic = Object.entries(principalCounts)
    .filter(([, count]) => count >= 3)
    .sort((a,b) => b[1] - a[1]);

  const banner = document.getElementById('warning-banner');
  if (systematic.length) {
    const [p, count] = systematic[0];
    banner.classList.remove('hidden');
    document.getElementById('warning-text').textContent =
      `‚ö† Systematic weakness detected: ${PRINCIPLE_LABELS[p] || p} has ${count} violations. This principle needs immediate attention.`;
  } else {
    banner.classList.add('hidden');
  }

  tbody.innerHTML = incidents.map((inc, i) => `
    <tr class="incident-row border-b border-blue-900/50" onclick="toggleIncident(${i})">
      <td class="px-4 py-3">
        <span class="text-xs font-medium text-blue-300">${PRINCIPLE_LABELS[inc.principle] || inc.principle}</span>
      </td>
      <td class="px-4 py-3">
        <span class="font-mono text-sm ${inc.score <= -1 ? 'text-red-400' : 'text-orange-400'} font-bold">${inc.score}</span>
      </td>
      <td class="px-4 py-3 max-w-xs">
        <p class="text-xs text-gray-300">${truncate(inc.user_prompt, 100)}</p>
      </td>
      <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap">
        ${formatTime(inc.conv_created_at)}
      </td>
    </tr>
    <tr id="expand-${i}" class="border-b border-blue-900/30">
      <td colspan="4" class="expand-content px-4 py-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 py-2">
          <div>
            <p class="text-xs text-gray-500 mb-1 font-medium">USER PROMPT</p>
            <p class="text-xs text-gray-300 bg-blue-900/20 rounded p-3 leading-relaxed">${escapeHtml(inc.user_prompt)}</p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1 font-medium">AI RESPONSE</p>
            <p class="text-xs text-gray-300 bg-blue-900/20 rounded p-3 leading-relaxed">${escapeHtml(inc.ai_response)}</p>
          </div>
          ${inc.rationale ? `
          <div class="md:col-span-2">
            <p class="text-xs text-gray-500 mb-1 font-medium">RATIONALE</p>
            <p class="text-xs text-orange-300 bg-orange-900/10 border border-orange-800/30 rounded p-3 leading-relaxed">${escapeHtml(inc.rationale)}</p>
          </div>` : ''}
        </div>
      </td>
    </tr>
  `).join('');
}

function toggleIncident(i) {
  const content = document.querySelector(`#expand-${i} .expand-content`);
  if (content) content.classList.toggle('open');
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function loadConversations() {
  try {
    const res = await fetch(`${API}/api/conversations?limit=50`);
    const data = await res.json();
    renderConvList(data);
  } catch(e) {
    console.error('Conversations load failed:', e);
  }
}

function renderConvList(convs) {
  const el = document.getElementById('conv-list');
  if (!convs.length) {
    el.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No conversations yet.</p>';
    return;
  }
  el.innerHTML = convs.map(c => {
    const score = c.overall_score;
    const scoreStr = score != null ? (score >= 0 ? `+${score.toFixed(2)}` : score.toFixed(2)) : '‚Ä¶';
    const colorClass = score != null ? scoreColor(score) : 'text-gray-400';
    return `
      <div onclick="loadConvDetail('${c.id}')"
           class="p-3 rounded-lg border border-blue-900/50 cursor-pointer hover:border-blue-700 transition"
           style="background:#0f0e17;">
        <div class="flex justify-between items-start mb-1">
          <span class="text-xs text-gray-500">${formatTime(c.created_at)}</span>
          <span class="text-sm font-bold ${colorClass}">${scoreStr}</span>
        </div>
        <p class="text-xs text-gray-300 leading-relaxed">${truncate(c.user_prompt, 70)}</p>
        ${c.model ? `<p class="text-xs text-blue-400 mt-1">${c.model}</p>` : ''}
      </div>
    `;
  }).join('');
}

async function loadConvDetail(id) {
  try {
    const res = await fetch(`${API}/api/conversations/${id}`);
    const data = await res.json();
    renderConvDetail(data);
  } catch(e) {
    console.error('Conv detail load failed:', e);
  }
}

function renderConvDetail(data) {
  const { conversation: conv, evaluations, run } = data;
  const el = document.getElementById('conv-detail');

  const scoresByPrinciple = {};
  (evaluations || []).forEach(e => { scoresByPrinciple[e.principle] = e; });

  const overallScore = run?.overall_score;
  const overallStr = overallScore != null
    ? (overallScore >= 0 ? `+${overallScore.toFixed(2)}` : overallScore.toFixed(2))
    : '‚Ä¶';

  el.innerHTML = `
    <div class="flex justify-between items-start mb-4">
      <div>
        <p class="text-xs text-gray-500">${formatTime(conv.created_at)}</p>
        ${conv.model ? `<p class="text-xs text-blue-400">${conv.model}</p>` : ''}
      </div>
      <span class="text-2xl font-bold ${overallScore != null ? scoreColor(overallScore) : 'text-gray-400'}">${overallStr}</span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div>
        <p class="text-xs text-gray-500 mb-2 font-medium">USER PROMPT</p>
        <div class="rounded-lg p-3 text-sm text-gray-200 leading-relaxed" style="background:#0f0e17; max-height:200px; overflow-y:auto;">
          ${escapeHtml(conv.user_prompt)}
        </div>
      </div>
      <div>
        <p class="text-xs text-gray-500 mb-2 font-medium">AI RESPONSE</p>
        <div class="rounded-lg p-3 text-sm text-gray-200 leading-relaxed" style="background:#0f0e17; max-height:200px; overflow-y:auto;">
          ${escapeHtml(conv.ai_response)}
        </div>
      </div>
    </div>

    <p class="text-xs text-gray-500 mb-3 font-medium">PRINCIPLE SCORES</p>
    <div class="space-y-3">
      ${PRINCIPLE_ORDER.map(p => {
        const ev = scoresByPrinciple[p];
        const score = ev?.score ?? null;
        const pct = score != null ? ((score + 1) / 2) * 100 : 50;
        const barClass = score != null ? scoreBarClass(score) : 'bg-gray-600';
        const colorClass = score != null ? scoreColor(score) : 'text-gray-400';
        const scoreStr = score != null ? (score >= 0 ? `+${score.toFixed(1)}` : score.toFixed(1)) : '‚Ä¶';
        return `
          <div>
            <div class="flex justify-between text-xs mb-1">
              <span class="text-gray-400">${PRINCIPLE_LABELS[p]}</span>
              <span class="${colorClass} font-semibold">${scoreStr}</span>
            </div>
            <div class="h-2.5 rounded-full" style="background:#0f3460;">
              <div class="h-2.5 rounded-full ${barClass}" style="width:${pct}%;"></div>
            </div>
            ${ev?.rationale ? `<p class="text-xs text-orange-300 mt-1 pl-1">‚Ü≥ ${escapeHtml(ev.rationale)}</p>` : ''}
          </div>
        `;
      }).join('')}
    </div>

    ${run?.global_violations && JSON.parse(run.global_violations || '[]').length ? `
    <div class="mt-4 p-3 rounded-lg border border-red-800/30 bg-red-900/10">
      <p class="text-xs text-red-400 font-medium mb-1">Global Violations</p>
      <ul class="text-xs text-red-300 space-y-1">
        ${JSON.parse(run.global_violations).map(v => `<li>‚Ä¢ ${escapeHtml(v)}</li>`).join('')}
      </ul>
    </div>` : ''}
  `;
}

function updateLastUpdated() {
  document.getElementById('last-updated').textContent =
    'Updated ' + new Date().toLocaleTimeString();
}

async function refresh() {
  if (currentTab === 'overview') await loadOverview();
  if (currentTab === 'incidents') await loadIncidents();
  if (currentTab === 'conversations') await loadConversations();
  updateLastUpdated();
}

// Initial load
loadOverview();
updateLastUpdated();

// Auto-refresh every 30 seconds
setInterval(refresh, 30000);
</script>
</body>
</html>
